---
import Layout from '../layouts/Layout.astro';

const isBrowser = typeof window !== 'undefined';
const isAuthenticated = isBrowser ? !!localStorage.getItem('celestia_currentUser') : false;

if (isBrowser && !isAuthenticated) {
  window.location.href = '/login';
}
---

<Layout title="Panel de Control - CelestiaCom">
  <main class="dashboard-container">
    <h1>Panel de Control</h1>
    <div id="estacion-info" class="estacion-section">
      <h2>Tu Estación</h2>
      <p id="current-estacion">Cargando...</p>
      <input type="text" id="new-estacion-name" placeholder="Nuevo nombre" class="estacion-input">
      <button id="update-estacion-btn" class="update-button">Actualizar Nombre</button>
    </div>
  </main>
</Layout>

<style>
  .dashboard-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--azul-oscuro);
    border-radius: 8px;
    border: 1px solid var(--azul-medio);
  }

  .estacion-section {
    margin-top: 2rem;
  }

  .estacion-input {
    width: 100%;
    padding: 0.75rem;
    margin: 0.5rem 0;
    background: var(--azul-profundo);
    border: 1px solid var(--azul-medio);
    border-radius: 4px;
    color: var(--texto-claro);
  }

  .update-button {
    padding: 0.75rem 1.5rem;
    background: var(--acento-verde);
    color: var(--azul-profundo);
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .update-button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
</style>

<script>
  // Mostrar información del usuario
  const user = JSON.parse(localStorage.getItem('celestia_currentUser'));
  if (user) {
    document.getElementById('current-estacion').textContent = user.estacion;
  }

  // Verificar autenticación al cargar
  if (!user) {
    window.location.href = '/CelestiaCom/login/';  // Cambiado
  }

  // Actualizar estación
  document.getElementById('update-estacion-btn').addEventListener('click', () => {
    const newName = document.getElementById('new-estacion-name').value.trim();
    if (!newName) {
      alert('⚠️ Escribe un nombre válido');
      return;
    }

    const users = JSON.parse(localStorage.getItem('celestia_users'));
    const currentUser = JSON.parse(localStorage.getItem('celestia_currentUser'));
    
    const userIndex = users.findIndex(u => u.id === currentUser.id);
    if (userIndex !== -1) {
      users[userIndex].estacion = newName;
      localStorage.setItem('celestia_users', JSON.stringify(users));
      localStorage.setItem('celestia_currentUser', JSON.stringify(users[userIndex]));
      
      document.getElementById('current-estacion').textContent = newName;
      alert('✅ Nombre actualizado!');
      document.getElementById('new-estacion-name').value = '';
    }
  });
</script>